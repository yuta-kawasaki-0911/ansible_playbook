---
## 
- name: edit resolv.conf
  lineinfile: 
    dest=/etc/resolv.conf
    line={{ item }}
  with_items:
    - 'options timeout:3 attempts:2'
    - 'nameserver 118.67.70.18'
    - 'nameserver 202.131.202.5'
    - 'nameserver 8.8.8.8'
##
- name: edit sshd_config
  replace: dest=/etc/ssh/sshd_config regexp='#PermitRootLogin yes' replace='PermitRootLogin yes' backup=yes

## 
- name: edit profile
  replace: dest=/etc/profile regexp='export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL' replace='export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE INPUTRC' backup=yes

##ある場合
- name: exist
  stat: path=/etc/modprobe.d/nf_conntrack.conf
  register: fm
- name: insert text
  lineinfile:
    dest=/etc/modprobe.d/nf_conntrack.conf
    line={{ item }}
  with_items:
    - options nf_conntrack hashsize=37500  
  when: fm.stat.exists
##ない場合
- name: not exist
  stat: path=/etc/modprobe.d/nf_conntrack.conf
  register: am
- name: touch file
  shell: touch /etc/modprobe.d/nf_conntrack.conf
  when: not am.stat.exists
- name: insert text (touch)
  lineinfile:
    dest=/etc/modprobe.d/nf_conntrack.conf
    line={{ item }}
  with_items:
    - options nf_conntrack hashsize=37500  
##
- name: edit sysctl.conf
  lineinfile:
    dest=/etc/sysctl.conf
    line={{ item }}
  with_items:
    - '#add FullSpeed'
    - 'net.ipv6.conf.all.disable_ipv6 = 1'
    - 'net.ipv6.conf.default.disable_ipv6 = 1'
    - 'net.ipv6.conf.lo.disable_ipv6 = 1'
    - 'vm.swappiness = 0'
    - 'net.ipv4.tcp_fin_timeout=5'
    - 'net.ipv4.tcp_max_tw_buckets=900000'
    - 'net.ipv4.tcp_max_syn_backlog = 60000'
    
    - '#for iptables against Lost packet'
    - 'net.netfilter.nf_conntrack_max  = 300000'
    - 'net.nf_conntrack_max = 300000'
    - 'net.core.somaxconn = 1024'
    - 'net.core.netdev_max_backlog = 30720'
    - 'net.ipv4.ip_local_port_range = 32768 65535'
    - 'net.ipv4.tcp_tw_reuse = 1'
    - 'net.core.rmem_max = 16777216'
    - 'net.core.wmem_max = 16777216'
    - 'net.ipv4.tcp_rmem = 4096 87380 16777216'
    - 'net.ipv4.tcp_wmem = 4096 87380 16777216'
##
- name: ntp
  stat: path=/etc/cron.hourly/ntpdcron
  register: ntp
- name: touch file
  shell: touch /etc/cron.hourly/ntpdcron
  when: not am.stat.exists
- name: insert text (touch)
  lineinfile:
    dest=/etc/cron.hourly/ntpdcron
    line={{ item }}
  with_items:
    - '#!/bin/bash'
    - '/usr/sbin/ntpdate ns1.freebit.net > /dev/null 2>&1'
##
- name: change permission
  shell: >
    chmod 755 /etc/cron.hourly/ntpdcron;
    /etc/cron.hourly/ntpdcron;

- name: add users to sudoers
  lineinfile: 
    dest=/etc/sudoers
    insertbefore='## Allows members of the 'sys' group to run networking, software,'
    line={{ item }}
  with_items:
    - 'Defaults:zabbix !requiretty'
    - 'zabbix ALL=(ALL) NOPASSWD: /usr/sbin/dmidecode -s *'
    - 'zabbix ALL=(ALL) NOPASSWD: /usr/sbin/dmidecode -t *'
    - 'zabbix ALL=(hdfs) NOPASSWD: /usr/bin/hadoop dfsadmin -report'

#################################################
##
## CentOS Base repository 
##
##################################################

##Centos6.3
- name: copy repository for Centos6.3
  copy: >
    src=centos6.3/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.3'
##Centos6.4
- name: copy repository for Centos6.4
  copy: >
    src=centos6.4/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.4'
##Centos6.5
- name: copy repository for Centos6.5
  copy: >
    src=centos6.5/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.5'
##Centos6.6
- name: copy repository for Centos6.6
  copy: >
    src=centos6.6/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.6'
##Centos6.7
- name: copy repository for Centos6.7
  copy: >
    src=centos6.7/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.7'
##Centos6.8
- name: copy repository for Centos6.8
  copy: >
    src=centos6.8/CentOS-Vault.repo
    dest=/etc/yum.repos.d/
  when: ansible_distribution_version == '6.8'
