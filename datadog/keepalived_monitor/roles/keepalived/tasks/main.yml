---
- name: Register process.yaml stat
  stat:
    path: /etc/datadog-agent/conf.d/process.d/conf.yaml
  register: process_yaml

- name: Check if keepalived instance is in process.d/conf.yaml
  when: process_yaml.stat.exists == True
  become: yes
  shell: "grep '^- name:\\s*keepalived' /etc/datadog-agent/conf.d/process.d/conf.yaml"
  register: keepalived
  ignore_errors: true
  
- name: Append keepalived instance if process.d/conf.yaml exists
  when: process_yaml.stat.exists == True and keepalived.stdout == ''
  become: yes
  blockinfile:
    path: /etc/datadog-agent/conf.d/process.d/conf.yaml
    block: |
      - name: keepalived
        search_string: ['keepalived']
    marker: "# {mark} KeepAlived monitor"
  
- name: Copy conf.yaml if it does not exist yet
  when: process_yaml.stat.exists == False
  copy:
    src: conf.yaml
    dest: /etc/datadog-agent/conf.d/process.d/
  become: true

- become: yes
  file:
    path: /etc/datadog-agent/conf.d/process.d/conf.yaml
    owner: dd-agent
    group: dd-agent

- name: restart datadog-agent
  become: true
  service:
    name: datadog-agent
    state: restarted
    enabled: yes
