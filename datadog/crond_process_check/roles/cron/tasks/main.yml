---
- stat: path=/etc/datadog-agent/conf.d/process.yaml
  register: process_yaml

- name: Check if "cron" instance is in process.yaml
  shell: "grep '^- name: cron' /etc/datadog-agent/conf.d/process.yaml"
  register: cron_instance
  ignore_errors: true
  when: process_yaml.stat.exists == True

- name: append cron instance if process.yaml exists and cron instance does not exist yet
  become: true
  blockinfile:
    path: /etc/datadog-agent/conf.d/process.yaml
    block: |
      - name: cron
        search_string: ["crond"]
        exact_match: False
    marker: "# {mark} Cron is running monitor"
  when: process_yaml.stat.exists == True and cron_instance.stdout == ''

- name: copy process.yaml if it does not exist yet
  copy:
    src: process.yaml
    dest: /etc/datadog-agent/conf.d/.
  when: process_yaml.stat.exists == False
  become: true

- name: restart datadog-agent
  become: true
  service:
    name: datadog-agent
    state: restarted
    enabled: yes
