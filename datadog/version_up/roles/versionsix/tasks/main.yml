---
- name: run datadog install_script.sh
  become: true
  shell: DD_UPGRADE=true bash -c "$(curl -L https://raw.githubusercontent.com/DataDog/datadog-agent/master/cmd/agent/install_script.sh)"

- name: register all the py in /etc/dd-agent/checks.d/
  become: yes
  stat:
    path: /etc/dd-agent/checks.d
  register: check_dir

- name: register all the py in /etc/dd-agent/checks.d/
  become: true
  shell: ls *.py
  args:
    chdir: /etc/dd-agent/checks.d/
  register: py_files
  when: check_dir.stat.exists == true

- name: move python files to /etc/datadog-agent/checks.d/
  become: true
  shell: "cp /etc/dd-agent/checks.d/{{ item }} /etc/datadog-agent/checks.d/"
  with_items: "{{ py_files.stdout_lines }}"
  when: check_dir.stat.exists == true

- name: restart datadog-agent
  become: true
  service:
    name: datadog-agent
    state: restarted
    enabled: yes
